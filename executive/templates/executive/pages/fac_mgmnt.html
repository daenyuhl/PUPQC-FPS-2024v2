{% extends 'base.html' %}
{% load static %}
{% block content %}
{% csrf_token %}

    <style>
        .breadcrumb-item + .breadcrumb-item::before {
            content: "/" !important;
        }

        .gridjs-tbody, td.gridjs-td,
        .gridjs *, .gridjs ::after, .gridjs ::before,
        .table {
            font-size: var(--vz-body-font-size);
        }

        .mt-n5{
            margin-top: -5rem !important;;
        }

        .profile-wid-bg::before {
            background: linear-gradient(to top, #660000, #3e0000);
        }

        .mt-n5{
            padding-top: 2.5rem !important;
        }
        
    </style>

    <div class="row">
        <div class="col-lg-12">
            <div class="card mt-n4 mx-n4">
                <div class="bg-primary-subtle">
                    <div class="card-body px-4 pb-4">
                        <div class="row mb-3">
                            <div class="col-md">
                                <div class="row align-items-center g-3">
                                    <div class="col-md-auto">
                                        <div class="avatar-md">
                                            <div class="avatar-title bg-transparent">
                                                <i class="ri-shield-user-line" style="font-size: 3rem !important;"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md">
                                        <div>
                                                <h4 class="fw-bold text-white">Faculty Management</h4>
                                            <div class="hstack gap-3 flex-wrap text-white">
                                                <div id="evalBreadtime"><i class="ri-map-pin-2-line align-bottom me-1"></i></div>
                                                <div class="vr"></div>
                                                <div>Post Date : <span id="evalBreaddate"></span></div>
                                                <div class="vr"></div>
                                                <div>Your Designation: <div class="badge rounded-pill bg-secondary fs-12">Academic Head</div></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- modal -->
            <div class="modal fade" id="faculty_mgmt_modal" aria-hidden="true" aria-labelledby="..." tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">

                        <style>
                            #chart-loader {
                                position: absolute;
                                top: 50%;
                                left: 50%;/* 
                                transform: translate(-50%, -50%);
                                display: none;
                                z-index: 9999; Ensure it appears above other elements */
                            }
                        </style>

                        <div class="d-flex justify-content-center align-items-center">
                            <div id="chart-loader" class="spinner-border text-primary" role="status" style="display: none;"></div>
                        </div>

                        <div class="modal-header">
                            <h5 class="modal-title">Present Year Evaluation Performance</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="card card-height-100">
                                <div class="w-100">
                                    <div id="faculty-mgmt-chart"></div>
                                </div>
                            </div>
                        </div>

                        <div class="modal-header">
                            <h5 class="modal-title">Overall Academic Research Performance</h5>
                        </div>
                        <div class="modal-body">
                            <div class="card card-height-100">
                                <div class="w-100">
                                    <div id="rsrch_performance"></div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-n5">
        <div class="col-lg-12">
            <div class="card ">
                <div class="card-header">
                    <h4 class="card-title mb-0 flex-grow-1">List of Faculty Members</h4>
                </div>

                <div class="card-body">
                    <table id="fac_dtble" class="display table table-bordered dt-responsive dataTable dtr-inline" style="width:100%">
                        <thead>
                            <tr>
                                <th>Faculty Name</th>
                                <th>Faculty Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{% static 'js/main/eval_upload/eval_u_datentime.js' %}"></script>
    {% comment %} <script src="{% static 'js/main/faculty_mgmt/faculty_mgmt.js' %}"></script> {% endcomment %}

    <script>
        function getCSRFToken() {
            var csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
            return csrfToken;
        }
        
        $(document).ready(function () {
            $('#fac_dtble').DataTable({
                "ajax": {
                    "url": "mrt_promotion",
                    "dataSrc": ""
                },
                "columns": [
                    { "data": "merit_faculty_name" },
                    { "data": "merit_faculty_status" },
                    {
                        "data": null,
                        "render": function (data, type, full, meta) {
                            return '<center><button type="button" class="btn btn-sm btn-primary attendees-btn" data-bs-toggle="modal" data-bs-target="#faculty_mgmt_modal"  data-faculty-name="' + full.merit_faculty_name + '">Performances</button></center>';
                        }
                    }
                ]
            });
            if (dataTable.data().count() === 0) {
                $('#fac_dtble tbody').html('<tr><td colspan="9">There is currently no data in the database.</td></tr>');
            }
        });


        var faculty_chart;
        var rsrch_chart;

        // AJAX request on button click
        $('#fac_dtble tbody').on('click', 'button.attendees-btn', function() {
            var clickedFacultyName = $(this).data('faculty-name');
            console.log(clickedFacultyName)

            $('#faculty-mgmt-chart').empty();
            $('#chart-loader').show();

            $.ajax({
                url: "fac_mgmnt",
                type: "POST",
                data: {
                    csrfmiddlewaretoken: getCSRFToken(),
                    faculty_name: clickedFacultyName
                },

                success: function(response) {
                    $('#chart-loader').fadeOut();

                    function FacultyPerformance() {
                        var faculty_dataa = response.faculty_mgmt;
                        console.log(faculty_dataa)
                        var semesterData = [
                            {
                                name: 'First Semester',
                                data: [
                                    faculty_dataa.Supervisor_First[0],
                                    faculty_dataa.Student_First[0],
                                    faculty_dataa.Peer_First[0],
                                    faculty_dataa.Self_First[0]
                                ]
                            },
                            {
                                name: 'Second Semester',
                                data: [
                                    faculty_dataa.Supervisor_Second[0],
                                    faculty_dataa.Student_Second[0],
                                    faculty_dataa.Peer_Second[0],
                                    faculty_dataa.Self_Second[0]
                                ]
                            },
                        ];
                        var options = {
                            chart: {
                                type: 'bar',
                                height: 345,
                                zoom: { enabled: true },
                                toolbar: { show: false },
                            },

                            plotOptions: {
                                bar: {
                                    horizontal: false,
                                    columnWidth: '60%',
                                    endingShape: 'rounded',
                                },
                            },

                            colors: [
                                getComputedStyle(document.documentElement).getPropertyValue('--vz-info'),
                                getComputedStyle(document.documentElement).getPropertyValue('--vz-primary'),
                                getComputedStyle(document.documentElement).getPropertyValue('--vz-secondary')
                            ],

                            xaxis: {
                                categories: ['Supervisor Evaluation', 'Student Evaluation', 'Peer Evaluation', 'Self Evaluation'],
                                title: {
                                    text: 'Rating',
                                },
                            },

                            yaxis: {
                                title: {
                                    text: 'Evaluation Scores',
                                },
                            },
                            
                            series: semesterData,
                        };
                        if (faculty_chart) {
                            faculty_chart.destroy();
                            faculty_chart = new ApexCharts(document.querySelector("#faculty-mgmt-chart"), options);
                            faculty_chart.render();
                        } else {
                            faculty_chart = new ApexCharts(document.querySelector("#faculty-mgmt-chart"), options);
                            faculty_chart.render();
                        }
                    } FacultyPerformance();

                    function ResearchPerformance() {
                        var f_research_data = response.publication_counts;
                        console.log(f_research_data)
                        var years = Object.keys(f_research_data);
                        var counts = years.map(year => f_research_data[year].count);
                        var options = {
                            chart: {
                                height: 380,
                                type: "bar",
                                zoom: { enabled: false },
                                toolbar: { show: false },
                            },
                            
                            colors: [
                                getComputedStyle(document.documentElement).getPropertyValue('--vz-info'),
                                getComputedStyle(document.documentElement).getPropertyValue('--vz-primary'),
                                getComputedStyle(document.documentElement).getPropertyValue('--vz-secondary'),
                            ],
                            
                            dataLabels: {
                                enabled: !1
                            },

                            stroke: {
                                width: [3, 3],
                                curve: "straight"
                            },

                            series: [
                                {
                                    name: 'No. of Research Published',
                                    data: counts
                                },
                            ],

                            grid: {
                                row: { colors: ["transparent", "transparent"], opacity: 0.2 },
                                borderColor: "#f1f1f1",
                            },

                            markers: {
                                style: "inverted",
                                size: 6
                            },

                            xaxis: {
                                categories: years,
                                title: { text: "Academic Year" },
                            },

                            yaxis: {
                                title: {
                                    text: "Research Count"
                                },
                                min: 0,
                                max: 10
                            },

                            legend: {
                                position: "top",
                                horizontalAlign: "right",
                                floating: !0,
                                offsetY: -25,
                                offsetX: -5,
                            },

                            responsive: [
                                {
                                    breakpoint: 600,
                                    options: { chart: { toolbar: { show: !1 } }, legend: { show: !1 } },
                                },
                            ],
                        }
                        if (rsrch_chart) {
                            rsrch_chart.destroy();
                            rsrch_chart = new ApexCharts(document.querySelector("#rsrch_performance"), options);
                            rsrch_chart.render();
                        } else {
                            rsrch_chart = new ApexCharts(document.querySelector("#rsrch_performance"), options);
                            rsrch_chart.render();
                        }
                    } ResearchPerformance();

                    $('#chart-loader').hide();
                },
                error: function(error) {
                    console.log("Error:", error);
                }
            });
        });

    </script>
{% endblock %}